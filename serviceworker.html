<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> sw 生命周期测试 </title>
  <!-- TODO add manifest here -->
  <link rel="manifest" href="./manifest.json">
  <!-- Add to home screen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="DEMO">
  <link rel="apple-touch-icon" href="src/icons/152_152.png">
  <style>
    .pic{
      float: left;
      list-style: none;
    }
    .pic img{
      margin: 10px;
      width: 200px;
      border: 1px solid #ccc;
      padding: 4px;
    }
  </style>
</head>
<body>
  <img src="src/logo.png" alt="logo"/>
  <ul id="relay"></ul>
  <form>
    <input type="text" placeholder="输入发给sw的信息" />
    <input type="submit" value="发送" />
  </form>
  <input type="button" value="打开push通知" id="subscribe"/>
  <input type="button" value="断开网络，然后猛戳一下" id="sync"/>
  <input type="button" value="手动更新worker" id="update"/>
  <div>
    <a href="other.html">测试另外一个页面是否一样拥有sw</a>
  </div>
  <ul>
    <li class="pic">
      <img src="src/images/1.jpeg">
    </li>
    <li class="pic">
      <img src="src/images/2.jpeg">
    </li>
    <li class="pic">
      <img src="src/images/3.jpeg">
    </li>
    <li class="pic">
      <img src="src/images/4.jpeg">
    </li>
  </ul>
  <script>
    // 请求权限
    Notification.requestPermission()
    /**
     * 1、默认scope是sw.js所在的目录
     * 2、可以通过scope参数设置sw的scope, 不能设置大于sw.js所在目录的scope，所以一般把sw.js放在根目录/
     */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('sw.js'/*, {scope: '/src/scope'} */)
        .then((reg) => {
          console.log(`SW注册成功, scope是：${reg.scope}`)
        })
        .catch((err) => {
          console.log(`SW注册失败: ${err}`)
        })

      // 注册发送message逻辑
      document.querySelector('form').onsubmit = (e) => {
        let val = document.querySelector('input[type="text"]').value || '这个家伙很懒，什么也没发'
        navigator.serviceWorker.controller.postMessage(val)
        e.preventDefault()
      }

      // 注册SW响应message的消息
      navigator.serviceWorker.addEventListener('message', ({data}) => {
        let body = ''
        switch (data.type) {
          case 'message':
            body = data.message
            break
          case 'push':
            body = data.body
            break
          default:
            break
        }

        let relay = document.querySelector('#relay')
        relay.innerHTML = relay.innerHTML + `<li>${body}</li>`
      })

      // 添加订阅push
      document.querySelector('#subscribe').onclick = () => {
        navigator.serviceWorker.ready.then((reg) => {
          reg.pushManager.subscribe({userVisibleOnly: true})
            .then((subscription) => {
              let endpoint = subscription.endpoint
              let key = subscription.getKey('p256dh')
              key = btoa(String.fromCharCode.apply(null, new Uint8Array(key)))
              console.log(endpoint, key)
              // 订阅的时候需要做的是将生成的endpoint跟key发送到服务器，让服务器记录下这两个值
              // 从而能正确帮忙推送到确定的webapp中
            })
            .catch((err) => {
              console.log(err)
            })
        })
      }

      // 注册一个background sync
      document.querySelector('#sync').onclick = () => {
        navigator.serviceWorker.ready.then((reg) => {
          return reg.sync.register('mySync')
        })
        .catch(console.log)
      }

      // 注册一个更新worker事件
      document.querySelector('#update').onclick = () => {
        navigator.serviceWorker.ready.then((reg) => {
          return reg.update()
        })
      }
    }


    // 测试安装完成后不刷新加载的请求, 也不会被捕获
    setTimeout(() => {
      console.log('do setTimeout')
      let img = new Image()
      img.src = 'src/logo.png'
    }, 2000)
  </script>
</body>
</html>
